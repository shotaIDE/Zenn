---
title: "私のモバイルプロジェクトにおけるトランクベース開発によるリリース戦略"
emoji: "⛴️"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["ios", "android"]
published: false
---

プロジェクトでトランクベース開発を実施しています。
1 年ほど運用してみて、どのようなメリット・デメリットがあるかをまとめました。

# 導入背景

リリースにおけるリスクやコストを最小化し、リリースの頻度が高められるようにすることを目指すため導入しました。

# 採用しているトランクベース開発の概要

リリースの際には、トランクブランチにはマージされない前提で、リリースブランチを作成します。

受け入れテストを行なった際にバグが見つかった場合、トランクブランチに対して修正し、リリースブランチにチェリーピックします。

トランクブランチを唯一のメンテナンスしていくブランチとしているので、トランクブランチに修正します。
この上で、トランクブランチの特定の時点で切り出してリリースするために必要なコミットをチェリーピックによりかき集めたものとします。

この辺りは、トランクブランチとリリースブランチの乖離はそこまで大きくないことを根拠にしています。
トランクブランチとリリースブランチの乖離が大きければこの戦略は適用できないため、大きくならないよう開発フローを最適化していく必要があります。

## メリット

### 開発メンバーが実施しなければならないブランチ管理が限りなく簡単になる

- ブランチ管理やコンフリクト対応、マージ対応などを全てのメンバーが行うには、ハードルが高いため
- ブランチ管理にコストを取られ、価値提供にコストを使えなくなるのを防ぎたいため

### 1 本のブランチ上で開発、テスト、自動チェック(CI)を集中することで、これらのコストパフォーマンスを最大化できる

- CI の価値を最大化するため
- 定期的な自動・手動リグレッションテストのコストを最小にしつつ、価値を最大化するため
- 開発者・QA が同じブランチを触る・検証する
- トランクブランチが壊れた場合にすぐに気づきやすく、復元時間を最短にできる。

### 副次的な効果として、フィーチャーフラグによりリリースの柔軟性やベータテストの柔軟性が高まる

- リモートで管理することにより、切り戻しの範囲を柔軟に設定でき、切り戻しの所要時間を最小化できる
- 範囲や段階を柔軟に設定したカナリアリリースができる
- アプリ内で管理することにより、アーリーアクセス機能としてのリリースができる
  - ユーザーによるフィードバックを得ることができる

# デメリット

## 開発やテスト、リリースの複雑性が増す

- 一時的に分岐が発生することにより、コードの複雑さが増す
- サイレントリリースすることにより、デプロイや監視のオペレーションパターンが増える
- フィーチャートグルを外すことを将来行う必要がある

## ブランチ管理の代わりにフィーチャートグルを利用することが必須なため、その学習コストが発生する

- プロダクトオーナー、QA など関係者すべてに周知し、キャッチアップしてもらう必要がある

# メリットとデメリットの比較

Git-flow などのブランチ戦略に比べて、トランクベース開発によるリリース戦略は以下のような特徴があります。

開発中の機能もフィーチャーフラグなどを利用してトランクブランチにマージされていきます。
これにより、全ての開発メンバーがビルドし修正するコードに早期統合されるため、設計の破綻やコードの不都合を早期に発見しやすくなります。

全ての開発メンバーで 1 つのコードを共有し、全ての QA メンバーで 1 つのアプリを検証することになります。

リリース前のタイミングで統合するよりも、早いタイミングで統合していくことで、統合の痛みを分散させていくという取り組みとも言えます。

このように考えることで、リリースの頻度を高めることができます。

コード中の分岐の扱いを間違えるというミスよりもブランチ管理を間違えるというミスの方が体感としては発生しやすいです。

これらを踏まえ、将来的に目指す方向性と合っていると考えて、採用し運用中です。

# 運用上必要になってくること

## フィーチャーフラグの仕組み

## 開発単位をできるだけ小さく保つ

チェリーピックする際にコンフリクトが発生する可能性を下げる。
複数のコミットが同時多発的に一本のブランチにマージされていくので、何か問題が発生した時に、切り分けができるように。

## フィーチャーフラグやビルドツールの活用によりマージとリリースを分離する

開発中の中途半端な機能もフィーチャーフラグを用いて一般には公開されない状態にしつつ、リリースできる状態とする。

## 滞留するチケットを監視し、リリースできるように促す

1 つのチケットを 1 つの PR で対応できればいいが、そうできない場合も発生する。
その際は、一定期間(2 週間程度)より長く滞留してしまったら、以下のいずれかの方針をとる。

1. 対応した PR により機能のデグレーションが発生している
   - 一旦トランクブランチ上でリバートし、再着手時に再度 PR を立てる
2. 対応した PR により機能のデグレーションが発生していないものの、チケットに記載しているバグが完全には解消していない
   - PR をリリースする。チケットに`記載時点までのPRをリリース可能`という日付フィールドに、判断した日付を入力する。
3. 対応した PR により機能のデグレーションは発生しておらず、チケットに記載しているバグが解消している一方で、別のバグが見つかっている
   - チケットを完了としてリリースまで持っていき、別のバグは別チケットで管理する。

## Squash マージを強制し、PR1 つに対し 1 つのコミットが生成されるようにする

GitHub の設定を変更し、Squash マージとする。
これは、最終的にメインブランチに PR のタイトルがコミットメッセージとされたコミット履歴を残し、コミットごとにリリース計画を立てやすくするため。
また、PR ごとの細かいコミットに気を使うのはコストもかかるし、自然とできるメンバーも少ないので、細かいコミットを捨てるため。

## トランクブランチのいつでもある程度致命的なバグが存在しない状態の水準にすることが求められる

品質を担保した後にマージというフェーズが取らないため。

# 概要

- メインブランチを常にリリース可能な状態に保つ。
- リリースブランチにマージし、必要に応じてチェリーピックを使う。

# ユーザーストーリー

- 前回のリリースからの差分を GitHub の PR としてレビューしたい

# 前提

- リリース済みの
- プロダクトオーナーが考える単位で
- GitHub で PR を利用した開発している

# 前提となる知識

Git は親コミットに対して差分を適用していく構造になっている。
そのため、コミット 1→ コミット 2→ コミット 3 という順番で並んでいた時に、コミット 1→ コミット 3 という順番で並び替えるためにはチェリーピックが必要となる。

チェリーピックはマージと異なり、コミット 3 の差分をコミット 1 の子として新しく作り直すという作業になる。
そのため、元々のコミット 3 とは別のハッシュ値を持つコミット 3 ができる。

# 普段の開発における立ち振る舞い

## 1 本のブランチに対し全ての変更をコミットしていく

メインブランチからブランチを立て、直接メインブランチにマージする PR を立てる。

## バックログチケットへの紐付けを強制する

Danger を利用し、PR のタイトルをチェックする CI を組んでいます。
また、Squash コミットで PR タイトルが最終的なコミットメッセージとなるようにします。

# リリース作業

GitHub の PR に対し、リリース管理のためのラベルを用意し、そのラベルに応じてリリース計画を立てる。

以下のコマンドにより、トランクブランチにおけるコミット履歴のうちリリースブランチにマージしていないものを古い順に精査していく。

```bash
git log --date=iso --pretty=format:"%s" release..main
```

https://zenn.dev/yoichi/articles/git-dotted-notations

## 概要

### リリース計画を立てる

以下のように前回のリリースからトランクブランチが進んでいるコミット一覧を確認します。

```shell
git log --pretty=format:'%H %cd %s' --date=format:'%Y-%m-%d %H:%M:%S' 'release/3.5.0(364)'..'main'
```

### PR にリリース済みラベルがついているものはリリースブランチにマージされている

### PR に特定のラベルをつけることでリリースに含める・含めないを管理する

`記載時点までのPRをリリース可能`が付与されていて、その日付よりも前の PR であれば含めるようにする。

### タグをつけることで、リリースの地点を管理する

この際、マージコミットにタグを付与してしまうと履歴のツリーから参照できないコミットにタグが付与されてしまうため、リリースレビューブランチにタグを打つ。

### GitHub にリリースレビューブランチを作り、リリースブランチへのマージ PR を作り、リリース作業を行う

### リリースブランチは Squash マージではなく、通常のマージを行う

## チェック作業

一度リリースに含まれる内容が過不足ないかを人手でチェックできるように、チェックするためのフローを挟んでいる。

# 追加でビルドした場合

切り戻し資材に関して、追加ビルド後には Android も新しい切り戻し資材をビルドする必要がある。
Android の Google Play では、更新アプリを公開するためにはバージョン名(1.0.0 など)に関わらずバージョン番号が大きいものをアップロードする必要があるためです。
iOS はそうした制約がないので、対応不要です。

# hotfix での作業

# 参考

- Google のソフトウェアエンジニアリング -持続可能なプログラミングを支える技術、文化、プロセス-
