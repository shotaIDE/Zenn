---
title: "モバイルでできそうなテスト駆動開発のアイデアを思いついたので聞いて欲しい"
emoji: "🌟"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["ios", "android"]
published: false
---

プロジェクトの課題を解決するための 1 つの施策を考えついたので、メモしておきます。

# 前提・背景

プロジェクトで以下のような課題がありました。

- 画面仕様書を定義して開発やテストを進めているが、エンジニアが画面仕様書の細部まで読み込めていない場合がある
- 単体テストコードを書いているものの、デグレの防止、コードの各レイヤーの責務の整理、仕様の妥当性見直しなどのきっかけとなっている実感が薄い

:::message
画面仕様書は、以下のように画面デザインと動作が記載されたドキュメントです。

![](/images/mobile-ui-logic-behavior-driven-development/screen-spec-image.png)

- (1)をタップした際
  - 投稿に成功した場合
    - 投稿画面を閉じる
  - 投稿に失敗した場合
    - トーストで、「投稿に失敗しました。時間を空けて再度お試しください」と表示する

:::

# アイデアの概要

コード実装時、以下のように進めるようにします。

1. 画面仕様書における条件に応じた表示やアクションに応じた UI の挙動に対し、画面ロジック部分のみをテストコードとして定義
2. 1 の後、プロダクトコードを実装

# 詳細

## テスト対象

実装する際に参照する画面仕様書における、条件に応じた表示やアクションに応じた UI の挙動とします。

これらの条件**全てに対し、条件 1 つに対して 1 つのテストコードが対応する**ように書きます。

## テストコード実装時の方針

### UI はテストせず、かつスモールテストの範囲とする

![](/images/mobile-ui-logic-behavior-driven-development/testing-layers.png)

安定性や速度を高めるための方針です。

この内容が UI ロジックレイヤーから出力されれば、UI は正常に表示されるだろう、という前提に立ち、UI ロジックの入出力を確認します。

また、スモールテストなので、1 つのプロセス内で完結するようにします。
つまり、API や DB、キーバリューストアは本物を利用せず、モックを使います。

ただし、API、DB、キーバリューストアのレイヤーのモックを利用すると、依存関係によっては Android で実機テストにする必要が生じます。
そのため、リポジトリのレイヤーをモックにする方が良さそうです。

UI ロジックに近い場所をモックしすぎると、UI ロジックに紐づくアプリの動作のテストにならないため、それ以外の部分は全て本物を使います。
また、モックしすぎるとホワイトボックステストに近くなり、仕様変更やリファクタリング時にテストコードが壊れやすくなります。

### 画面仕様書の分岐を全て網羅する。また、それ以上のテストはしない

必要十分にテストケースを網羅するための方針です。

テストケースが多すぎるとメンテナンスコストは膨れ上がっていくので、特に、書かれていない分岐のテストは書かないという方向の意識が重要です。

## 考えられるメリット

- エンジニアが仕様の理解をする機会が増える
- 画面仕様書の理解度の属人性により、動作確認の品質にばらつく可能性が下がる
- 動作確認の再実行を容易にし、リファクタリングの心理的ハードルが下がる
- UI や UI ロジック周りでテストコードを実装することで、責務を整理すべき箇所の発見機会が増える
- 包括的な自動テストが実装されることに繋げ、エンジニア・QA が品質に対して根拠ある自信を持てる
- iOS/Android、あるいは Web や API などの開発者間で相互レビューできる可能性がある

## 考えられるデメリット

- 工数はかかる
- アーキテクチャーの事前に整備しておく必要があるかも
- テストコードの実装がしやすいよう、画面仕様書の書き方を工夫する必要があるかも

# 最後に

まだ実践していないので、机上の空論の可能性もあります。
実験中ですので、続報をお待ちください。
