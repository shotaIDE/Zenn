---
title: "完全に自動でメンテナンスリリースされていくモバイルアプリを作ってみる実験"
emoji: "👌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ios", "android"]
published: false
---

# はじめに

個人アプリ開発では、確保できるプライベートの時間の不安定さにより開発できない期間が発生しやすいです。
開発できない期間が空くと、再開した時に利用しているライブラリの多くが最新ではなくなっていて、辛いライブラリのアップデート作業が発生します。

開発できない期間でも、ライブラリ更新とそのアップデートリリースを自動化できれば、再開した際の手間を減らすことができます。
また、ユーザーに対してメンテナンスされているアプリであるという印象を与えることができます。

本記事では、完全に自動でライブラリ更新のアップデートがリリースされていくモバイルアプリを作ってみる方法を紹介します。

# 概要

ライブラリ更新を PR 作成からマージまで自動化しておき、メインのブランチにライブラリ更新が定期的にマージされるようにしておきます。

上記とは別サイクルの自ら定義した頻度で、自動リリースの処理を動かします。

この際、各所で静的解析や自動テストのチェックを入れることで、品質を担保しておきます。

また、アプリ審査状況を保持するデータストアを用意し、自動リリースの処理が多重で動かないようにします。

# 前提

アプリ公開時のリリースノートは以下のような固定の文言を定義しておき、それを全てのリリースで適用するという前提です。

```text
細かいバグ修正とパフォーマンスの向上を行いました。
```

# フロー概要

![](/images/automated-regular-release-for-mobile/automated-release-flow.png)

前提として、モバイルアプリのアップデート公開にはアプリ審査を通過する必要があります。

アプリ審査は、iOS は 1〜2 日、Android は数時間で完了することが多いです。

概要としては、定期的に自動アップデートリリースのトリガーを動かし、アプリ審査中でなくかつ前回のリリースから差分が生じている場合は、リリース作業を進めていきます。

トリガーの頻度は変数なので、どの程度の頻度でリリースしてもいいかを元に決定します。

定期アップデートのトリガーとは別サイクルで、開発作業を行います。
ライブラリの自動アップデートなども行います。

メインのブランチは常にリリース可能な状態に保っておきます。

E2E 自動テストを行い、リリース作業のブロックとすることで、デグレしていない状態でリリースが担保できます。

# 具体的な実装方法

## ライブラリの自動アップデート

dependabot によりライブラリの自動更新の PR が作成されるようにしておきます。

## 静的解析、単体テスト

静的解析や単体テストを PR のマージ必須条件としておきます。

ライブラリのアップデートで、アプリ内で利用しているメソッドが利用不可になったり deprecated になった場合は、これらが失敗します。

## PR の自動マージ

PR で静的解析、単体テストが通った場合、Mergify を利用して自動でマージされるようにします。

https://mergify.com/

## 前のリリースの審査中ではないかを判定する

Google スプレッドシートを読み取り、前回のリリースが審査中でないかを判定します。

## 前回のリリースから差分があるかを判定する

リリース時に付与される Git のタグを元に、最新コミットまでの差分を確認し、差分がある場合はリリース作業を進めます。

これには、GitHub Actions の Changed Files というアクションを利用しています。

https://github.com/marketplace/actions/changed-files

## リリース作業開始時にデータストアを更新

Google スプレッドシートに、リリース作業開始を記録します。

## E2E 自動テスト

Maestro Cloud とその GitHub Actions を利用しています。

https://cloud.mobile.dev/

## 審査完了後のリリース通知による、データストア更新

リリース完了のメール通知が来た際に、Google スプレッドシートを更新します。

Zapier を利用しています。

## データストア更新時に、iOS / Android の両方ともリリースされたかを判定

Google スプレッドシートの変更時に発動する、Apps Script を利用しています。

iOS と Android 両方ともリリース通知が揃った場合に、スプレッドシートを更新します。
