---
title: "私のモバイルプロジェクトにおけるトランクベース開発によるリリース戦略の実現方法"
emoji: "⛴️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ios", "android"]
published: false
---

# 概要

- メインブランチを常にリリース可能な状態に保つ。
- リリースブランチにマージし、必要に応じてチェリーピックを使う。

# ユーザーストーリー

- 前回のリリースからの差分を GitHub の PR としてレビューしたい

# 前提

- リリース済みの
- プロダクトオーナーが考える単位で
- GitHub で PR を利用した開発している

# 普段の開発における立ち振る舞い

## 1 本のブランチに対し全ての変更をコミットしていく

メインブランチからブランチを立て、直接メインブランチにマージする PR を立てる。

## バックログチケットへの紐付けを強制する

Danger を利用し、PR のタイトルをチェックする CI を組んでいます。
また、Squash コミットで PR タイトルが最終的なコミットメッセージとなるようにします。

# リリース作業

GitHub の PR に対し、リリース管理のためのラベルを用意し、そのラベルに応じてリリース計画を立てる。

以下のコマンドにより、トランクブランチにおけるコミット履歴のうちリリースブランチにマージしていないものを古い順に精査していく。

```bash
git log --date=iso --pretty=format:"%s" release..main
```

https://zenn.dev/yoichi/articles/git-dotted-notations

## 概要

### リリース計画を立てる

以下のように前回のリリースからトランクブランチが進んでいるコミット一覧を確認します。

```shell
git log --pretty=format:'%H %cd %s' --date=format:'%Y-%m-%d %H:%M:%S' 'release/3.5.0(364)'..'main'
```

### PR にリリース済みラベルがついているものはリリースブランチにマージされている

### PR に特定のラベルをつけることでリリースに含める・含めないを管理する

`記載時点までのPRをリリース可能`が付与されていて、その日付よりも前の PR であれば含めるようにする。

### タグをつけることで、リリースの地点を管理する

この際、マージコミットにタグを付与してしまうと履歴のツリーから参照できないコミットにタグが付与されてしまうため、リリースレビューブランチにタグを打つ。

### GitHub にリリースレビューブランチを作り、リリースブランチへのマージ PR を作り、リリース作業を行う

### リリースブランチは Squash マージではなく、通常のマージを行う

## チェック作業

一度リリースに含まれる内容が過不足ないかを人手でチェックできるように、チェックするためのフローを挟んでいる。

# 追加でビルドした場合

切り戻し資材に関して、追加ビルド後には Android も新しい切り戻し資材をビルドする必要がある。
Android の Google Play では、更新アプリを公開するためにはバージョン名(1.0.0 など)に関わらずバージョン番号が大きいものをアップロードする必要があるためです。
iOS はそうした制約がないので、対応不要です。

# hotfix での作業

# 参考

- Google のソフトウェアエンジニアリング -持続可能なプログラミングを支える技術、文化、プロセス-
