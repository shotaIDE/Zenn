---
title: "個人アプリ「うちのコメロディー」の技術構成"
emoji: "⚒️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["dependabot", "gradle", "android"]
published: false
---

以下のようなモバイルアプリをリリースしたので、技術的な話をまとめておきます。

https://apps.apple.com/us/app/%E3%81%86%E3%81%A1%E3%81%AE%E3%82%B3%E3%83%A1%E3%83%AD%E3%83%87%E3%82%A3%E3%83%BC/id6450181110

https://play.google.com/store/apps/details?id=ide.shota.colomney.MyPetMelody

# 選定の方針

動画から猫の鳴き声を検知したり、自動で動画を生成する必要があり、かつ、それらの知見がほとんどない状態でした。
そのため、それら以外でできるだけ知見のない新しい技術を使わないようにしました。

# モバイルアプリ

Flutter を使い、iOS/Android 両方とも実装しています。

# サーバー

## ローカル開発用

Firebase の Emulator を使い、普段の開発時には、ローカルのみで完結するようにしています。
ローカル PC の IP アドレスはよく変化します。
また、個人開発なのでないですが、チームメンバーにこれらの IP アドレスを記載したファイルを共有するのはイケてないです。
Flutter で Dart-Defines を使い、そのファイルを Git の管理対象外としています。

## API

アプリから呼び出す API は Cloud Functions を利用しています。

## 非同期処理

動画を生成する処理は、Cloud Tasks を使って非同期で処理するようにしています。

## ストレージ

Firebase Storage を利用しています。
クライアントからアップロード、ダウンロードする際は、モバイルアプリから直接アクセスしています。
そのために、Storage のセキュリティルールにより、各ユーザーはそのユーザー専用のディレクトリ階層のみ読み書きできるように制限しています。

## データベース

Firebase Firestore を利用しています。
クライアントから参照する際は、モバイルアプリから直接 Firestore にアクセスしています。
そのために、Firestore のセキュリティルールにより、各ユーザーはそのユーザー専用のコレクション配下のみ読み取れるように制限しています。

## 分析

Firebase Analytics を利用しています。
基本的に自動で収集されるイベントを収集するだけにしています。
ただし、最も体験して欲しい一連の機能の流れの中で、どの段階でユーザーが脱落したかを分析できるように、カスタムイベントを一部だけ埋め込んでいます。
また、画面遷移は収集しています。

## 鳴き声検知

無音検知の Python ライブラリを使っています。

## 監視

Firebase Crashlytics を利用しています。
自動で収集されるイベントを収集するだけにしています。
また、Flutter における例外発生をキャッチできるようにしています。

# サブスクリプション課金

RevenueCat を利用し、モバイルアプリ側の課金処理と、サーバー側の課金状態チェックを実装しています。

# 認証

Firebase Authentication を使っています。
匿名認証を利用し、アカウント作成せずにアプリの機能が使えるようにしています。
また、Google アカウントと X(Twitter)アカウント、Apple でサインインが利用できるようにしています。

# IaC

Terraform を使い、Firebase プロジェクトの作成をはじめとする以下の構築を自動化しています。

- Google Cloud プロジェクトと、それに紐づく Firebase プロジェクトの作成
- Firebase Authentication の匿名認証の有効化
- Firebase Storage の有効化とセキュリティルールの設定
- Firebase Firestore の有効化とセキュリティルールの設定
- Cloud Tasks におけるタスクキューの作成と設定

Terraform の Firebase のプロバイダー自体がまだベータ機能なので、一部手の届かない部分があります。

# CI/CD

Fastlane と GitHub Actions を利用し、自動の静的解析、自動テスト、自動ビルド、自動デプロイを組んでいます。

# テスト

鳴き声検知のアルゴリズムのベンチマークと、主要なケース 1 ケースのみの E2E テスト、モバイルアプリのロジック周りの単体テストを書いています。

鳴き声検知のアルゴリズムのベンチマークは、ある時点のアルゴリズムで叩き出せる評価値から変化がないかというのをチェックするものです。
サンプルの動画を 6 つほど用意し、それらの鳴き声がもっともらしく検知できたかどうかを評価する数値を計算しています。

E2E テストは Maestro を利用して記載しています。
単純なテストケースなら YAML に操作内容を記載していくだけで済むので、非常に手軽で使い勝手が良いです。

モバイルアプリのロジック周りの単体テストは Flutter の標準のテストフレームワークを利用しています。
