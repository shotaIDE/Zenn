---
title: "個人アプリ「うちのコメロディー」の技術構成"
emoji: "⚒️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["dependabot", "gradle", "android"]
published: false
---

以下のようなモバイルアプリをリリースしたので、技術的な話をまとめておきます。

https://apps.apple.com/us/app/%E3%81%86%E3%81%A1%E3%81%AE%E3%82%B3%E3%83%A1%E3%83%AD%E3%83%87%E3%82%A3%E3%83%BC/id6450181110

https://play.google.com/store/apps/details?id=ide.shota.colomney.MyPetMelody

# どういったアプリか？

猫の動画から、以下のようなオリジナルの音楽を作ることができるアプリです。

https://twitter.com/colomney/status/1730919744558293034

技術的には、以下のような仕組みが含まれています。

- 選択された猫の動画を解析し、鳴き声部分を自動で検知する
- BGM に鳴き声の音声を合成し、音声ファイルを生成する
- 音声ファイルと一枚の画像から、静止画の動画を生成する

# 選定の方針

音声から猫の鳴き声を検知したり、自動で動画を生成する必要があり、かつ、それらの知見がほとんどない状態でした。
そのため、それら以外はできるだけ個人的な知見のある技術を使うようにしました。

# 構成

## モバイルアプリ

Flutter を使い、iOS/Android 両方とも実装しています。

## API

アプリから呼び出す API は Cloud Functions を利用しています。

Cloud Functions for Firebase ではなく Cloud Functions を直接使っているのは、Cloud Tasks との連携がしやすかったためです。

## 非同期処理

動画を生成する処理は、Cloud Tasks を使って非同期で処理するようにしています。

## ストレージ

Firebase Storage を利用しています。

モバイルアプリから動画などをアップロード、ダウンロードする際は、API を介さず直接アクセスしています。
そのために、Storage のセキュリティルールにより、各ユーザーはそのユーザー専用のディレクトリ階層のみ読み書きできるように制限しています。

Cloud Functions からも動画生成の際にユーザーがアップロードした動画を参照するために、アクセスしています。

## データベース

Firebase Firestore を利用しています。

モバイルアプリで UI 表示のために参照する際やプッシュ通知のトークンを登録する際に、API を介さず直接アクセスしています。
そのために、Firestore のセキュリティルールにより、各ユーザーはそのユーザー専用のコレクション配下のみ読み書きできるように制限しています。

モバイルアプリからアクセスする際は、監視のコネクションを張り、変更をリアルタイムで UI へ反映できるようにしています。

Cloud Functions からは、生成された動画のメタデータを書き込んだり、プッシュ通知のトークンを取得するために、アクセスしています。

## 鳴き声検知

Pydub ライブラリを使っています。

https://pydub.com/

## サブスクリプション課金

RevenueCat を利用し、モバイルアプリ側の課金処理と、サーバー側の課金状態チェックを実装しています。

https://www.revenuecat.com/

## 認証

Firebase Authentication を使っています。

匿名認証を利用し、アカウント作成せずにアプリの機能が使えるようにしています。
また、Google アカウントと X(Twitter)アカウント、Apple でサインインが利用できるようにしています。

## プッシュ通知

Firebase Cloud Messaging を利用しています。

アプリでプッシュ通知送信用のトークンが発行されたら、Firebase Firestore にトークンを登録します。
また、Cloud Functions 上で Firestore からトークンを取得し、プッシュ通知を送信します。

## 分析

Firebase Analytics を利用しています。

デフォルト設定で自動的に収集してくれるものの他に、画面遷移のイベントを収集するようにしています。

また、アプリ中最も重要なユーザー体験の一連の流れにおいて、どの段階でユーザーが離脱したかを分析できるように、カスタムイベントを一部だけ埋め込んでいます。

## 監視

Firebase Crashlytics を利用しています。

デフォルト設定で自動的に収集してくれるものの他に、Flutter における例外発生を収集するようにしています。

## 単体テスト

鳴き声検知のアルゴリズムのベンチマークと、モバイルアプリのロジック周りの単体テストを書いています。

鳴き声検知のアルゴリズムのベンチマークは、ある時点のアルゴリズムで叩き出せる評価値から変化がないかというのをチェックするものです。
サンプルの動画を 6 つほど用意し、それらの鳴き声がもっともらしく検知できたかどうかを評価する数値を計算しています。

モバイルアプリのロジック周りの単体テストは Flutter の標準のテストフレームワークを利用しています。

## E2E テスト

E2E テストは Maestro を利用して記載しています。

https://maestro.mobile.dev/

単純なテストケースなら YAML に操作内容を記載していくだけで済むので、非常に手軽で使い勝手が良いです。

アプリ中最も重要なユーザー体験の 1 つのみ書いています。

## ローカル開発

Firebase のローカルエミューレーターを使い、普段の開発時はローカルのみで完結するようにしています。

https://firebase.google.com/docs/emulator-suite?hl=ja

開発中における Google Cloud や Firebase の利用頻度を減らし、コストを削減することが目的です。

また、モバイルアプリをローカルエミュレーターに向けて場合、PC の LAN におけるプライベート IP アドレスをアプリに渡す必要があります。
プライベート IP アドレスは環境により変化するので、コード上にコミットしたくないです。
そのため、ビルド時に変数の記載したファイルを渡せる仕組み(Dart-Defines)を使い、変数を記載したファイルを Git の管理対象外としています。

```json:dart-defines.json
{
  "SERVER_HOST": "192.168.10.13"
}
```

```bash
flutter run --dart-define-from-file "dart-defines.json"
```

## IaC

Terraform を使い、Firebase プロジェクトの作成をはじめとする以下の構築を自動化しています。

- Google Cloud プロジェクトと、それに紐づく Firebase プロジェクトの作成
- Firebase Authentication の匿名認証の有効化
- Firebase Storage の有効化とセキュリティルールの設定
- Firebase Firestore の有効化とセキュリティルールの設定
- Cloud Tasks におけるタスクキューの作成と設定

Terraform の Firebase のプロバイダー自体がまだベータ機能なので、一部手の届かない部分があります。

## CI/CD

Fastlane と GitHub Actions を利用し、自動の静的解析、自動テスト、自動ビルド、自動デプロイを組んでいます。
