---
title: "個人アプリ「うちのコメロディー」の技術構成"
emoji: "🤖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["dependabot", "gradle", "android"]
published: true
---

以下のようなモバイルアプリをリリースしたので、技術的な話をまとめておきます。

https://apps.apple.com/us/app/%E3%81%86%E3%81%A1%E3%81%AE%E3%82%B3%E3%83%A1%E3%83%AD%E3%83%87%E3%82%A3%E3%83%BC/id6450181110

https://play.google.com/store/apps/details?id=ide.shota.colomney.MyPetMelody

# 選定の方針

動画から猫の鳴き声を検知したり、自動で動画を生成する必要があり、かつ、それらの知見がほとんどない状態でした。
そのため、それら以外でできるだけ知見のない新しい技術を使わないようにしました。

# モバイルアプリ

# サーバー

## API

アプリから呼び出す API は Cloud Functions を利用しています。

## 非同期処理

動画を生成する処理は、Cloud Tasks を使って非同期で処理するようにしています。

## ストレージ

Firebase Storage を利用しています。

## データベース

Firebase Firestore を利用しています。

## 分析

Firebase Analytics を利用しています。

## 鳴き声検知

無音検知の Python ライブラリを使っています。

## 監視

Firebase Crashlytics を利用しています。

# サブスクリプション課金

RevenueCat を利用し、モバイルアプリ側の課金処理と、サーバー側の課金状態チェックを実装しています。

# 認証

Firebase Authentication を使っています。

# CI/CD

Fastlane と GitHub Actions を利用し、自動の静的解析、自動テスト、自動ビルド、自動デプロイを組んでいます。

# テスト

鳴き声検知のアルゴリズムのベンチマークと、主要なケース 1 ケースのみの E2E テスト、モバイルアプリのロジック周りの単体テストを書いています。

鳴き声検知のアルゴリズムのベンチマークは、ある時点のアルゴリズムで叩き出せる評価値から変化がないかというのをチェックするものです。
サンプルの動画を 6 つほど用意し、それらの鳴き声がもっともらしく検知できたかどうかを評価する数値を計算しています。

E2E テストは Maestro を利用して記載しています。
単純なテストケースなら YAML に操作内容を記載していくだけで済むので、非常に手軽で使い勝手が良いです。

モバイルアプリのロジック周りの単体テストは Flutter の標準のテストフレームワークを利用しています。
